# debian-12-freepbx.yaml
# Create with: limactl start ./debian-12-freepbx.yaml

images:
- location: "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-amd64.qcow2"
  arch: "x86_64"
- location: "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-arm64.qcow2"
  arch: "aarch64"

mounts:
- location: "~"
  writable: true
# Removed /tmp/lima mount since it may not exist

containerd:
  system: false
  user: false

provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    export DEBIAN_FRONTEND=noninteractive

    # Basic system setup
    apt-get update -y
    apt-get install -y sudo curl ca-certificates gnupg lsb-release wget

    # Create default user
    useradd -m -s /bin/bash limabean
    echo "limabean ALL=(ALL) NOPASSWD:ALL" >/etc/sudoers.d/limabean
    chmod 440 /etc/sudoers.d/limabean

- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    sed -i 's/host.lima.internal.*/host.lima.internal/' /etc/hosts

- mode: user
  script: |
    #!/bin/bash
    set -eux -o pipefail
    # FreePBX installation
    cd /tmp
    wget https://github.com/FreePBX/sng_freepbx_debian_install/raw/master/sng_freepbx_debian_install.sh -O /tmp/sng_freepbx_debian_install.sh
    chmod +x /tmp/sng_freepbx_debian_install.sh
    sudo /tmp/sng_freepbx_debian_install.sh

probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 60s bash -c "until pgrep asterisk >/dev/null 2>&1; do sleep 5; done"; then
      echo >&2 "Asterisk is not running"
      exit 1
    fi
  hint: See "/var/log/pbx/freepbx17-install-*.log" in the guest

hostResolver: {}

portForwards:
- hostPort: 8080
  guestPort: 80
- hostPort: 2525
  guestPort: 25

message: |
  Debian 12 with FreePBX 17 is ready.
  Default user: limabean
  To enter the VM:
  ------
  limactl shell {{.Name}}
  ------
  FreePBX web interface is available on host port 8080.

